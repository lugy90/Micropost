<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0041)http://guides.ruby-china.org/routing.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Rails 路由全解 — Ruby on Rails 指南</title>
<link rel="stylesheet" type="text/css" href="./Rails 路由全解 — Ruby on Rails 指南_files/style.css">
<link rel="stylesheet" type="text/css" href="./Rails 路由全解 — Ruby on Rails 指南_files/print.css" media="print">

<link rel="stylesheet" type="text/css" href="./Rails 路由全解 — Ruby on Rails 指南_files/shCore.css">
<link rel="stylesheet" type="text/css" href="./Rails 路由全解 — Ruby on Rails 指南_files/shThemeRailsGuides.css">

<link rel="stylesheet" type="text/css" href="./Rails 路由全解 — Ruby on Rails 指南_files/fixes.css">

<link href="http://guides.ruby-china.org/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多内容 <a href="http://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多内容
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://rubyonrails.org/">综览</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/download">下载</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/deploy">部署</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">源码</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/screencasts">视频</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/documentation">文件</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/community">社群</a></li>
        <li class="more-info"><a href="http://weblog.rubyonrails.org/">Blog</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://guides.ruby-china.org/index.html" title="回首页">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://guides.ruby-china.org/index.html">首页</a></li>
        <li class="guides-index guides-index-large">
          <a href="http://guides.ruby-china.org/index.html" id="guidesMenu" class="guides-index-item nav-item">指南目录</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr>
              <dl class="L">
                <dt>入门</dt>
                <dd><a href="http://guides.ruby-china.org/getting_started.html">Rails 入门</a></dd>
                <dt>模型</dt>
                <dd><a href="http://guides.ruby-china.org/active_record_basics.html">Active Record 基础</a></dd>
                <dd><a href="http://guides.ruby-china.org/active_record_migrations.html">Active Record 数据库迁移</a></dd>
                <dd><a href="http://guides.ruby-china.org/active_record_validations.html">Active Record 数据验证</a></dd>
                <dd><a href="http://guides.ruby-china.org/active_record_callbacks.html">Active Record 回调</a></dd>
                <dd><a href="http://guides.ruby-china.org/association_basics.html">Active Record 关联</a></dd>
                <dd><a href="http://guides.ruby-china.org/active_record_querying.html">Active Record 查询</a></dd>
                <dt>视图</dt>
                <dd><a href="http://guides.ruby-china.org/layouts_and_rendering.html">Rails 布局和视图渲染</a></dd>
                <dd><a href="http://guides.ruby-china.org/form_helpers.html">Action View 表单帮助方法</a></dd>
                <dt>控制器</dt>
                <dd><a href="http://guides.ruby-china.org/action_controller_overview.html">Action Controller 简介</a></dd>
                <dd><a href="./Rails 路由全解 — Ruby on Rails 指南_files/Rails 路由全解 — Ruby on Rails 指南.html">Rails 路由全解</a></dd>
              </dl>
              <dl class="R">
                <dt>深入</dt>
                <dd><a href="http://guides.ruby-china.org/active_support_core_extensions.html">Active Support 核心扩展</a></dd>
                <dd><a href="http://guides.ruby-china.org/i18n.html">Rails 国际化 API</a></dd>
                <dd><a href="http://guides.ruby-china.org/action_mailer_basics.html">Action Mailer 基础</a></dd>
                <dd><a href="http://guides.ruby-china.org/active_job_basics.html">Active Job 基础</a></dd>
                <dd><a href="http://guides.ruby-china.org/security.html">Rails 安全指南</a></dd>
                <dd><a href="http://guides.ruby-china.org/debugging_rails_applications.html">调试 Rails 程序</a></dd>
                <dd><a href="http://guides.ruby-china.org/configuring.html">设置 Rails 程序</a></dd>
                <dd><a href="http://guides.ruby-china.org/command_line.html">Rails 命令行</a></dd>
                <dd><a href="http://guides.ruby-china.org/asset_pipeline.html">Asset Pipeline</a></dd>
                <dd><a href="http://guides.ruby-china.org/working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></dd>
                <dd><a href="http://guides.ruby-china.org/constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</a></dd>
                <dt>扩展 Rails</dt>
                <dd><a href="http://guides.ruby-china.org/rails_on_rack.html">Rails on Rack</a></dd>
                <dd><a href="http://guides.ruby-china.org/generators.html">客制与新建 Rails 产生器</a></dd>
                <dd><a href="http://guides.ruby-china.org/rails_application_templates.html">Rails 应用程式模版</a></dd>
                <dt>贡献 Ruby on Rails</dt>
                <dd><a href="http://guides.ruby-china.org/contributing_to_ruby_on_rails.html">贡献 Ruby on Rails</a></dd>
                <dd><a href="http://guides.ruby-china.org/api_documentation_guidelines.html">API 文件准则</a></dd>
                <dd><a href="http://guides.ruby-china.org/ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</a></dd>
                <dt>维护方针</dt>
                <dd><a href="http://guides.ruby-china.org/maintenance_policy.html">维护方针</a></dd>
                <dt>发布记</dt>
                <dd><a href="http://guides.ruby-china.org/upgrading_ruby_on_rails.html">升级 Ruby on Rails</a></dd>
                <dd><a href="http://guides.ruby-china.org/4_2_release_notes.html">Ruby on Rails 4.2 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/4_1_release_notes.html">Ruby on Rails 4.1 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/4_0_release_notes.html">Ruby on Rails 4.0 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/3_2_release_notes.html">Ruby on Rails 3.2 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/3_1_release_notes.html">Ruby on Rails 3.1 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/3_0_release_notes.html">Ruby on Rails 3.0 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/2_3_release_notes.html">Ruby on Rails 2.3 发布记</a></dd>
                <dd><a href="http://guides.ruby-china.org/2_2_release_notes.html">Ruby on Rails 2.2 发布记</a></dd>
              </dl>
          </div>
        </li>
        <!-- <li><a class="nav-item" href="//github.com/docrails-tw/wiki">参与翻译</a></li> -->
        <li><a class="nav-item" href="https://github.com/ruby-china/guides/blob/master/CONTRIBUTING.md">贡献</a></li>
        <li><a class="nav-item" href="http://guides.ruby-china.org/credits.html">致谢</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南目录</option>
              <optgroup label="入门">
                  <option value="getting_started.html">Rails 入门</option>
              </optgroup>
              <optgroup label="模型">
                  <option value="active_record_basics.html">Active Record 基础</option>
                  <option value="active_record_migrations.html">Active Record 数据库迁移</option>
                  <option value="active_record_validations.html">Active Record 数据验证</option>
                  <option value="active_record_callbacks.html">Active Record 回调</option>
                  <option value="association_basics.html">Active Record 关联</option>
                  <option value="active_record_querying.html">Active Record 查询</option>
              </optgroup>
              <optgroup label="视图">
                  <option value="layouts_and_rendering.html">Rails 布局和视图渲染</option>
                  <option value="form_helpers.html">Action View 表单帮助方法</option>
              </optgroup>
              <optgroup label="控制器">
                  <option value="action_controller_overview.html">Action Controller 简介</option>
                  <option value="routing.html">Rails 路由全解</option>
              </optgroup>
              <optgroup label="深入">
                  <option value="active_support_core_extensions.html">Active Support 核心扩展</option>
                  <option value="i18n.html">Rails 国际化 API</option>
                  <option value="action_mailer_basics.html">Action Mailer 基础</option>
                  <option value="active_job_basics.html">Active Job 基础</option>
                  <option value="security.html">Rails 安全指南</option>
                  <option value="debugging_rails_applications.html">调试 Rails 程序</option>
                  <option value="configuring.html">设置 Rails 程序</option>
                  <option value="command_line.html">Rails 命令行</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</option>
                  <option value="constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</option>
              </optgroup>
              <optgroup label="扩展 Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">客制与新建 Rails 产生器</option>
                  <option value="rails_application_templates.html">Rails 应用程式模版</option>
              </optgroup>
              <optgroup label="贡献 Ruby on Rails">
                  <option value="contributing_to_ruby_on_rails.html">贡献 Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API 文件准则</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</option>
              </optgroup>
              <optgroup label="维护方针">
                  <option value="maintenance_policy.html">维护方针</option>
              </optgroup>
              <optgroup label="发布记">
                  <option value="upgrading_ruby_on_rails.html">升级 Ruby on Rails</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 发布记</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 发布记</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 发布记</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 发布记</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 发布记</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 发布记</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 发布记</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 发布记</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  
  <hr class="hide">

  <div id="feature">
    <div class="wrapper">
      <h2>Rails 路由全解</h2><p>本文介绍面向用户的 Rails 路由功能。</p><p>读完本文，你将学到：</p>
<ul>
<li>如何理解 <code>routes.rb</code> 文件中的代码；</li>
<li>如何使用推荐的资源式，或使用 <code>match</code> 方法编写路由；</li>
<li>动作能接收到什么参数；</li>
<li>如何使用路由帮助方法自动创建路径和 URL；</li>
<li>约束和 Rack 端点等高级技术；</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="./Rails 路由全解 — Ruby on Rails 指南_files/chapters_icon.gif" alt="">Chapters</h3>
            <ol class="chapters">
<li>
<a href="http://guides.ruby-china.org/routing.html#rails-%E8%B7%AF%E7%94%B1%E7%9A%84%E4%BD%9C%E7%94%A8">Rails 路由的作用</a>

<ul>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%8A%8A-url-%E5%92%8C%E4%BB%A3%E7%A0%81%E8%BF%9E%E6%8E%A5%E8%B5%B7%E6%9D%A5">把 URL 和代码连接起来</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E7%94%9F%E6%88%90%E8%B7%AF%E5%BE%84%E5%92%8C-url">生成路径和 URL</a></li>
</ul>
</li>
<li>
<a href="http://guides.ruby-china.org/routing.html#%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84%EF%BC%9Arails-%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC">资源路径：Rails 的默认值</a>

<ul>
<li><a href="http://guides.ruby-china.org/routing.html#%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90">网络中的资源</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#crud%EF%BC%8Chttp-%E6%96%B9%E6%B3%95%E5%92%8C%E5%8A%A8%E4%BD%9C">CRUD，HTTP 方法和动作</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E8%B7%AF%E5%BE%84%E5%92%8C-url-%E5%B8%AE%E5%8A%A9%E6%96%B9%E6%B3%95">路径和 URL 帮助方法</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E4%B8%80%E6%AC%A1%E5%A3%B0%E6%98%8E%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%E8%B7%AF%E7%94%B1">一次声明多个资源路由</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%8D%95%E6%95%B0%E8%B5%84%E6%BA%90">单数资源</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%8E%A7%E5%88%B6%E5%99%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C%E8%B7%AF%E7%94%B1">控制器命名空间和路由</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%B5%8C%E5%A5%97%E8%B5%84%E6%BA%90">嵌套资源</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#routing-concerns">Routing Concerns</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E7%94%B1%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E8%B7%AF%E5%BE%84%E5%92%8C-url">由对象创建路径和 URL</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%B7%BB%E5%8A%A0%E6%9B%B4%E5%A4%9A%E7%9A%84-rest-%E6%9E%B6%E6%9E%84%E5%8A%A8%E4%BD%9C">添加更多的 REST 架构动作</a></li>
</ul>
</li>
<li>
<a href="http://guides.ruby-china.org/routing.html#%E9%9D%9E%E8%B5%84%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1">非资源式路由</a>

<ul>
<li><a href="http://guides.ruby-china.org/routing.html#%E7%BB%91%E5%AE%9A%E5%8F%82%E6%95%B0">绑定参数</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%8A%A8%E6%80%81%E8%B7%AF%E5%BE%84%E7%89%87%E6%AE%B5">动态路径片段</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E9%9D%99%E6%80%81%E8%B7%AF%E5%BE%84%E7%89%87%E6%AE%B5">静态路径片段</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%9F%A5%E8%AF%A2%E5%AD%97%E7%AC%A6%E4%B8%B2">查询字符串</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E5%80%BC">定义默认值</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%91%BD%E5%90%8D%E8%B7%AF%E7%94%B1">命名路由</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#http-%E6%96%B9%E6%B3%95%E7%BA%A6%E6%9D%9F">HTTP 方法约束</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E8%B7%AF%E5%BE%84%E7%89%87%E6%AE%B5%E7%BA%A6%E6%9D%9F">路径片段约束</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%9F%BA%E4%BA%8E%E8%AF%B7%E6%B1%82%E7%9A%84%E7%BA%A6%E6%9D%9F">基于请求的约束</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E9%AB%98%E7%BA%A7%E7%BA%A6%E6%9D%9F">高级约束</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E9%80%9A%E9%85%8D%E7%89%87%E6%AE%B5">通配片段</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E9%87%8D%E5%AE%9A%E5%90%91">重定向</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%98%A0%E5%B0%84%E5%88%B0-rack-%E7%A8%8B%E5%BA%8F">映射到 Rack 程序</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E4%BD%BF%E7%94%A8-root">使用 <code>root</code></a></li>
<li><a href="http://guides.ruby-china.org/routing.html#unicode-%E5%AD%97%E7%AC%A6%E8%B7%AF%E7%94%B1">Unicode 字符路由</a></li>
</ul>
</li>
<li>
<a href="http://guides.ruby-china.org/routing.html#%E5%AE%9A%E5%88%B6%E8%B5%84%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1">定制资源式路由</a>

<ul>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8%E7%9A%84%E6%8E%A7%E5%88%B6%E5%99%A8">指定使用的控制器</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%8C%87%E5%AE%9A%E7%BA%A6%E6%9D%9F">指定约束</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%94%B9%E5%86%99%E5%85%B7%E5%90%8D%E5%B8%AE%E5%8A%A9%E6%96%B9%E6%B3%95">改写具名帮助方法</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%94%B9%E5%86%99-new-%E5%92%8C-edit-%E7%89%87%E6%AE%B5">改写 <code>new</code> 和 <code>edit</code> 片段</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E4%B8%BA%E5%85%B7%E5%90%8D%E8%B7%AF%E7%94%B1%E5%B8%AE%E5%8A%A9%E6%96%B9%E6%B3%95%E5%8A%A0%E4%B8%8A%E5%89%8D%E7%BC%80">为具名路由帮助方法加上前缀</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E9%99%90%E5%88%B6%E7%94%9F%E6%88%90%E7%9A%84%E8%B7%AF%E7%94%B1">限制生成的路由</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E7%BF%BB%E8%AF%91%E8%B7%AF%E5%BE%84">翻译路径</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%94%B9%E5%86%99%E5%8D%95%E6%95%B0%E5%BD%A2%E5%BC%8F">改写单数形式</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%9C%A8%E5%B5%8C%E5%A5%97%E8%B5%84%E6%BA%90%E4%B8%AD%E4%BD%BF%E7%94%A8-:as-%E9%80%89%E9%A1%B9">在嵌套资源中使用 <code>:as</code> 选项</a></li>
</ul>
</li>
<li>
<a href="http://guides.ruby-china.org/routing.html#%E8%B7%AF%E7%94%B1%E5%AE%A1%E6%9F%A5%E5%92%8C%E6%B5%8B%E8%AF%95">路由审查和测试</a>

<ul>
<li><a href="http://guides.ruby-china.org/routing.html#%E5%88%97%E5%87%BA%E7%8E%B0%E6%9C%89%E8%B7%AF%E7%94%B1">列出现有路由</a></li>
<li><a href="http://guides.ruby-china.org/routing.html#%E6%B5%8B%E8%AF%95%E8%B7%AF%E7%94%B1">测试路由</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="rails-路由的作用">1 Rails 路由的作用</h3><p>Rails 路由能识别 URL，将其分发给控制器的动作进行处理，还能生成路径和 URL，无需直接在视图中硬编码字符串。</p><h4 id="把-url-和代码连接起来">1.1 把 URL 和代码连接起来</h4><p>Rails 程序收到如下请求时</p><div class="code_container">
<div><div id="highlighter_213217" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">GET /patients/17</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>会查询路由，找到匹配的控制器动作。如果首个匹配的路由是：</p><div class="code_container">
<div><div id="highlighter_274671" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/patients/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'patients#show'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>那么这个请求就交给 <code>patients</code> 控制器的 <code>show</code> 动作处理，并把 <code>{ id: '17' }</code> 传入 <code>params</code>。</p><h4 id="生成路径和-url">1.2 生成路径和 URL</h4><p>通过路由还可生成路径和 URL。如果把前面的路由修改成：</p><div class="code_container">
<div><div id="highlighter_146069" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/patients/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'patients#show'</code><code class="ruby plain">, as: </code><code class="ruby string">'patient'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>在控制器中有如下代码：</p><div class="code_container">
<div><div id="highlighter_485604" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby variable bold">@patient</code> <code class="ruby plain">= Patient.find(</code><code class="ruby constants">17</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>在相应的视图中有如下代码：</p><div class="code_container">
<div><div id="highlighter_330717" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Patient Record'</code><code class="ruby plain">, patient_path(</code><code class="ruby variable bold">@patient</code><code class="ruby plain">) </code><code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>那么路由就会生成路径 <code>/patients/17</code>。这么做代码易于维护、理解。注意，在路由帮助方法中无需指定 ID。</p><h3 id="资源路径：rails-的默认值">2 资源路径：Rails 的默认值</h3><p>使用资源路径可以快速声明资源式控制器所有的常规路由，无需分别为 <code>index</code>、<code>show</code>、<code>new</code>、<code>edit</code>、<code>create</code>、<code>update</code> 和 <code>destroy</code> 动作分别声明路由，只需一行代码就能搞定。</p><h4 id="网络中的资源">2.1 网络中的资源</h4><p>浏览器向 Rails 程序请求页面时会使用特定的 HTTP 方法，例如 <code>GET</code>、<code>POST</code>、<code>PATCH</code>、<code>PUT</code> 和 <code>DELETE</code>。每个方法对应对资源的一种操作。资源路由会把一系列相关请求映射到单个路由器的不同动作上。</p><p>如果 Rails 程序收到如下请求：</p><div class="code_container">
<div><div id="highlighter_721944" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">DELETE /photos/17</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>会查询路由将其映射到一个控制器的路由上。如果首个匹配的路由是：</p><div class="code_container">
<div><div id="highlighter_652723" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>那么这个请求就交给 <code>photos</code> 控制器的 <code>destroy</code> 方法处理，并把 <code>{ id: '17' }</code> 传入 <code>params</code>。</p><h4 id="crud，http-方法和动作">2.2 CRUD，HTTP 方法和动作</h4><p>在 Rails 中，资源式路由把 HTTP 方法和 URL 映射到控制器的动作上。而且根据约定，还映射到数据库的 CRUD 操作上。路由文件中如下的单行声明：</p><div class="code_container">
<div><div id="highlighter_559213" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>会创建七个不同的路由，全部映射到 <code>Photos</code> 控制器上：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>photos#index</td>
<td>显示所有图片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>photos#new</td>
<td>显示新建图片的表单</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>photos#create</td>
<td>新建图片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>photos#show</td>
<td>显示指定的图片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>photos#edit</td>
<td>显示编辑图片的表单</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>photos#update</td>
<td>更新指定的图片</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>photos#destroy</td>
<td>删除指定的图片</td>
</tr>
</tbody>
</table>
<div class="note"><p>路由使用 HTTP 方法和 URL 匹配请求，把四个 URL 映射到七个不同的动作上。
I&gt;
NOTE: 路由按照声明的顺序匹配哦，如果在 <code>get 'photos/poll'</code> 之前声明了 <code>resources :photos</code>，那么 <code>show</code> 动作的路由由 <code>resources</code> 这行解析。如果想使用 <code>get</code> 这行，就要将其移到 <code>resources</code> 之前。</p></div><h4 id="路径和-url-帮助方法">2.3 路径和 URL 帮助方法</h4><p>声明资源式路由后，会自动创建一些帮助方法。以 <code>resources :photos</code> 为例：</p>
<ul>
<li>
<code>photos_path</code> 返回 <code>/photos</code>
</li>
<li>
<code>new_photo_path</code> 返回 <code>/photos/new</code>
</li>
<li>
<code>edit_photo_path(:id)</code> 返回 <code>/photos/:id/edit</code>，例如 <code>edit_photo_path(10)</code> 返回 <code>/photos/10/edit</code>
</li>
<li>
<code>photo_path(:id)</code> 返回 <code>/photos/:id</code>，例如 <code>photo_path(10)</code> 返回 <code>/photos/10</code>
</li>
</ul>
<p>这些帮助方法都有对应的 <code>_url</code> 形式，例如 <code>photos_url</code>，返回主机、端口加路径。</p><h4 id="一次声明多个资源路由">2.4 一次声明多个资源路由</h4><p>如果需要为多个资源声明路由，可以节省一点时间，调用一次 <code>resources</code> 方法完成：</p><div class="code_container">
<div><div id="highlighter_629518" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, </code><code class="ruby color2">:books</code><code class="ruby plain">, </code><code class="ruby color2">:videos</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这种方式等价于：</p><div class="code_container">
<div><div id="highlighter_338175" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div><div class="line number2 index1 alt1"><code class="ruby plain">resources </code><code class="ruby color2">:books</code></div><div class="line number3 index2 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:videos</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="单数资源">2.5 单数资源</h4><p>有时希望不用 ID 就能查看资源，例如，<code>/profile</code> 一直显示当前登入用户的个人信息。针对这种需求，可以使用单数资源，把 <code>/profile</code>（不是 <code>/profile/:id</code>）映射到 <code>show</code> 动作：</p><div class="code_container">
<div><div id="highlighter_293256" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'profile'</code><code class="ruby plain">, to: </code><code class="ruby string">'users#show'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果 <code>get</code> 方法的 <code>to</code> 选项是字符串，要使用 <code>controller#action</code> 形式；如果是 Symbol，就可以直接指定动作：</p><div class="code_container">
<div><div id="highlighter_271689" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'profile'</code><code class="ruby plain">, to: </code><code class="ruby color2">:show</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>下面这个资源式路由：</p><div class="code_container">
<div><div id="highlighter_520465" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resource </code><code class="ruby color2">:geocoder</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>会生成六个路由，全部映射到 <code>Geocoders</code> 控制器：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/geocoder/new</td>
<td>geocoders#new</td>
<td>显示新建 geocoder 的表单</td>
</tr>
<tr>
<td>POST</td>
<td>/geocoder</td>
<td>geocoders#create</td>
<td>新建 geocoder</td>
</tr>
<tr>
<td>GET</td>
<td>/geocoder</td>
<td>geocoders#show</td>
<td>显示唯一的 geocoder 资源</td>
</tr>
<tr>
<td>GET</td>
<td>/geocoder/edit</td>
<td>geocoders#edit</td>
<td>显示编辑 geocoder 的表单</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/geocoder</td>
<td>geocoders#update</td>
<td>更新唯一的 geocoder 资源</td>
</tr>
<tr>
<td>DELETE</td>
<td>/geocoder</td>
<td>geocoders#destroy</td>
<td>删除 geocoder 资源</td>
</tr>
</tbody>
</table>
<div class="note"><p>有时需要使用同个控制器处理单数路由（例如 <code>/account</code>）和复数路由（例如 <code>/accounts/45</code>），把单数资源映射到复数控制器上。例如，<code>resource :photo</code> 和 <code>resources :photos</code> 分别声明单数和复数路由，映射到同个控制器（<code>PhotosController</code>）上。</p></div><p>单数资源式路由生成以下帮助方法：</p>
<ul>
<li>
<code>new_geocoder_path</code> 返回 <code>/geocoder/new</code>
</li>
<li>
<code>edit_geocoder_path</code> 返回 <code>/geocoder/edit</code>
</li>
<li>
<code>geocoder_path</code> 返回 <code>/geocoder</code>
</li>
</ul>
<p>和复数资源一样，上面各帮助方法都有对应的 <code>_url</code> 形式，返回主机、端口加路径。</p><div class="warning"><p>有个一直存在的问题导致 <code>form_for</code> 无法自动处理单数资源。为了解决这个问题，可以直接指定表单的 URL，例如：</p></div><div class="code_container">
<div><div id="highlighter_5262" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">form_for </code><code class="ruby variable bold">@geocoder</code><code class="ruby plain">, url: geocoder_path </code><code class="ruby keyword">do</code> <code class="ruby plain">|f|</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="控制器命名空间和路由">2.6 控制器命名空间和路由</h4><p>你可能想把一系列控制器放在一个命名空间内，最常见的是把管理相关的控制器放在 <code>Admin::</code> 命名空间内。你需要把这些控制器存在 <code>app/controllers/admin</code> 文件夹中，然后在路由中做如下声明：</p><div class="code_container">
<div><div id="highlighter_783085" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">namespace </code><code class="ruby color2">:admin</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>上述代码会为 <code>posts</code> 和 <code>comments</code> 控制器生成很多路由。对 <code>Admin::PostsController</code> 来说，Rails 会生成：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/admin/posts</td>
<td>admin/posts#index</td>
<td>admin_posts_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/new</td>
<td>admin/posts#new</td>
<td>new_admin_post_path</td>
</tr>
<tr>
<td>POST</td>
<td>/admin/posts</td>
<td>admin/posts#create</td>
<td>admin_posts_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/:id</td>
<td>admin/posts#show</td>
<td>admin_post_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/:id/edit</td>
<td>admin/posts#edit</td>
<td>edit_admin_post_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/admin/posts/:id</td>
<td>admin/posts#update</td>
<td>admin_post_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/admin/posts/:id</td>
<td>admin/posts#destroy</td>
<td>admin_post_path(:id)</td>
</tr>
</tbody>
</table>
<p>如果想把 <code>/posts</code>（前面没有 <code>/admin</code>）映射到 <code>Admin::PostsController</code> 控制器上，可以这么声明：</p><div class="code_container">
<div><div id="highlighter_952857" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope </code><code class="ruby keyword">module</code><code class="ruby plain">: </code><code class="ruby string">'admin'</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果只有一个资源，还可以这么声明：</p><div class="code_container">
<div><div id="highlighter_107095" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, </code><code class="ruby keyword">module</code><code class="ruby plain">: </code><code class="ruby string">'admin'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果想把 <code>/admin/posts</code> 映射到 <code>PostsController</code> 控制器（不在 <code>Admin::</code> 命名空间内），可以这么声明：</p><div class="code_container">
<div><div id="highlighter_26003" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope </code><code class="ruby string">'/admin'</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果只有一个资源，还可以这么声明：</p><div class="code_container">
<div><div id="highlighter_827085" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, path: </code><code class="ruby string">'/admin/posts'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>在上述两种用法中，具名路由没有变化，跟不用 <code>scope</code> 时一样。在后一种用法中，映射到 <code>PostsController</code> 控制器上的路径如下：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/admin/posts</td>
<td>posts#index</td>
<td>posts_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/new</td>
<td>posts#new</td>
<td>new_post_path</td>
</tr>
<tr>
<td>POST</td>
<td>/admin/posts</td>
<td>posts#create</td>
<td>posts_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/:id</td>
<td>posts#show</td>
<td>post_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/posts/:id/edit</td>
<td>posts#edit</td>
<td>edit_post_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/admin/posts/:id</td>
<td>posts#update</td>
<td>post_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/admin/posts/:id</td>
<td>posts#destroy</td>
<td>post_path(:id)</td>
</tr>
</tbody>
</table>
<div class="info"><p>如果在 <code>namespace</code> 代码块中想使用其他的控制器命名空间，可以指定控制器的绝对路径，例如 <code>get '/foo' =&gt; '/foo#index'</code>。</p></div><h4 id="嵌套资源">2.7 嵌套资源</h4><p>开发程序时经常会遇到一个资源是其他资源的子资源这种情况。假设程序中有如下的模型：</p><div class="code_container">
<div><div id="highlighter_117897" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">Magazine &lt; ActiveRecord::Base</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">has_many </code><code class="ruby color2">:ads</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">Ad &lt; ActiveRecord::Base</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">belongs_to </code><code class="ruby color2">:magazine</code></div><div class="line number7 index6 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>在路由中可以使用“嵌套路由”反应这种关系。针对这个例子，可以声明如下路由：</p><div class="code_container">
<div><div id="highlighter_773502" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:magazines</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:ads</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>除了创建 <code>MagazinesController</code> 的路由之外，上述声明还会创建 <code>AdsController</code> 的路由。广告的 URL 要用到杂志资源：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads</td>
<td>ads#index</td>
<td>显示指定杂志的所有广告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/new</td>
<td>ads#new</td>
<td>显示新建广告的表单，该告属于指定的杂志</td>
</tr>
<tr>
<td>POST</td>
<td>/magazines/:magazine_id/ads</td>
<td>ads#create</td>
<td>创建属于指定杂志的广告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#show</td>
<td>显示属于指定杂志的指定广告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/:id/edit</td>
<td>ads#edit</td>
<td>显示编辑广告的表单，该广告属于指定的杂志</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#update</td>
<td>更新属于指定杂志的指定广告</td>
</tr>
<tr>
<td>DELETE</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#destroy</td>
<td>删除属于指定杂志的指定广告</td>
</tr>
</tbody>
</table>
<p>上述路由还会生成 <code>magazine_ads_url</code> 和 <code>edit_magazine_ad_path</code> 等路由帮助方法。这些帮助方法的第一个参数是 <code>Magazine</code> 实例，例如 <code>magazine_ads_url(@magazine)</code>。</p><h5 id="嵌套限制">2.7.1 嵌套限制</h5><p>嵌套路由可以放在其他嵌套路由中，例如：</p><div class="code_container">
<div><div id="highlighter_211014" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:publishers</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:magazines</code> <code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>层级较多的嵌套路由很难处理。例如，程序可能要识别如下的路径：</p><div class="code_container">
<div><div id="highlighter_791515" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">/publishers/1/magazines/2/photos/3</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>对应的路由帮助方法是 <code>publisher_magazine_photo_url</code>，要指定三个层级的对象。这种用法很让人困扰，Jamis Buck 在<a href="http://weblog.jamisbuck.org/2007/2/5/nesting-resources">一篇文章</a>中指出了嵌套路由的用法总则，即：</p><div class="info"><p>嵌套资源不可超过一层。</p></div><h5 id="浅层嵌套">2.7.2 浅层嵌套</h5><p>避免深层嵌套的方法之一，是把控制器集合动作放在父级资源中，表明层级关系，但不嵌套成员动作。也就是说，用最少的信息表明资源的路由关系，如下所示：</p><div class="code_container">
<div><div id="highlighter_873475" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code><code class="ruby plain">, only: [</code><code class="ruby color2">:index</code><code class="ruby plain">, </code><code class="ruby color2">:new</code><code class="ruby plain">, </code><code class="ruby color2">:create</code><code class="ruby plain">]</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1"><code class="ruby plain">resources </code><code class="ruby color2">:comments</code><code class="ruby plain">, only: [</code><code class="ruby color2">:show</code><code class="ruby plain">, </code><code class="ruby color2">:edit</code><code class="ruby plain">, </code><code class="ruby color2">:update</code><code class="ruby plain">, </code><code class="ruby color2">:destroy</code><code class="ruby plain">]</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这种做法在描述路由和深层嵌套之间做了适当的平衡。上述代码还有简写形式，即使用 <code>:shallow</code> 选项：</p><div class="code_container">
<div><div id="highlighter_956149" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code><code class="ruby plain">, shallow: </code><code class="ruby keyword">true</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这种形式生成的路由和前面一样。<code>:shallow</code> 选项还可以在父级资源中使用，此时所有嵌套其中的资源都是浅层嵌套：</p><div class="code_container">
<div><div id="highlighter_557018" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, shallow: </code><code class="ruby keyword">true</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:quotes</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:drafts</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>shallow</code> 方法可以创建一个作用域，其中所有嵌套都是浅层嵌套。如下代码生成的路由和前面一样：</p><div class="code_container">
<div><div id="highlighter_96302" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">shallow </code><code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:quotes</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:drafts</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number7 index6 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>scope</code> 方法有两个选项可以定制浅层嵌套路由。<code>:shallow_path</code> 选项在成员路径前加上指定的前缀：</p><div class="code_container">
<div><div id="highlighter_410124" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope shallow_path: </code><code class="ruby string">"sekret"</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code><code class="ruby plain">, shallow: </code><code class="ruby keyword">true</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>上述代码为 <code>comments</code> 资源生成的路由如下：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/posts/:post_id/comments(.:format)</td>
<td>comments#index</td>
<td>post_comments_path</td>
</tr>
<tr>
<td>POST</td>
<td>/posts/:post_id/comments(.:format)</td>
<td>comments#create</td>
<td>post_comments_path</td>
</tr>
<tr>
<td>GET</td>
<td>/posts/:post_id/comments/new(.:format)</td>
<td>comments#new</td>
<td>new_post_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/sekret/comments/:id/edit(.:format)</td>
<td>comments#edit</td>
<td>edit_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#show</td>
<td>comment_path</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#update</td>
<td>comment_path</td>
</tr>
<tr>
<td>DELETE</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#destroy</td>
<td>comment_path</td>
</tr>
</tbody>
</table>
<p><code>:shallow_prefix</code> 选项在具名帮助方法前加上指定的前缀：</p><div class="code_container">
<div><div id="highlighter_318338" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope shallow_prefix: </code><code class="ruby string">"sekret"</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code><code class="ruby plain">, shallow: </code><code class="ruby keyword">true</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>上述代码为 <code>comments</code> 资源生成的路由如下：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/posts/:post_id/comments(.:format)</td>
<td>comments#index</td>
<td>post_comments_path</td>
</tr>
<tr>
<td>POST</td>
<td>/posts/:post_id/comments(.:format)</td>
<td>comments#create</td>
<td>post_comments_path</td>
</tr>
<tr>
<td>GET</td>
<td>/posts/:post_id/comments/new(.:format)</td>
<td>comments#new</td>
<td>new_post_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/comments/:id/edit(.:format)</td>
<td>comments#edit</td>
<td>edit_sekret_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/comments/:id(.:format)</td>
<td>comments#show</td>
<td>sekret_comment_path</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/comments/:id(.:format)</td>
<td>comments#update</td>
<td>sekret_comment_path</td>
</tr>
<tr>
<td>DELETE</td>
<td>/comments/:id(.:format)</td>
<td>comments#destroy</td>
<td>sekret_comment_path</td>
</tr>
</tbody>
</table>
<h4 id="routing-concerns">2.8 Routing Concerns</h4><p>Routing Concerns 用来声明通用路由，可在其他资源和路由中重复使用。定义 concern 的方式如下：</p><div class="code_container">
<div><div id="highlighter_582131" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">concern </code><code class="ruby color2">:commentable</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">concern </code><code class="ruby color2">:image_attachable</code> <code class="ruby keyword">do</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:images</code><code class="ruby plain">, only: </code><code class="ruby color2">:index</code></div><div class="line number7 index6 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Concerns 可在资源中重复使用，避免代码重复：</p><div class="code_container">
<div><div id="highlighter_761718" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:messages</code><code class="ruby plain">, concerns: </code><code class="ruby color2">:commentable</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code><code class="ruby plain">, concerns: [</code><code class="ruby color2">:commentable</code><code class="ruby plain">, </code><code class="ruby color2">:image_attachable</code><code class="ruby plain">]</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>上述声明等价于：</p><div class="code_container">
<div><div id="highlighter_674089" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:messages</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:comments</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:images</code><code class="ruby plain">, only: </code><code class="ruby color2">:index</code></div><div class="line number8 index7 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Concerns 在路由的任何地方都能使用，例如，在作用域或命名空间中：</p><div class="code_container">
<div><div id="highlighter_7625" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">namespace </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">concerns </code><code class="ruby color2">:commentable</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="由对象创建路径和-url">2.9 由对象创建路径和 URL</h4><p>除了使用路由帮助方法之外，Rails 还能从参数数组中创建路径和 URL。例如，假设有如下路由：</p><div class="code_container">
<div><div id="highlighter_468328" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:magazines</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:ads</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>使用 <code>magazine_ad_path</code> 时，可以不传入数字 ID，传入 <code>Magazine</code> 和 <code>Ad</code> 实例即可：</p><div class="code_container">
<div><div id="highlighter_861352" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Ad details'</code><code class="ruby plain">, magazine_ad_path(</code><code class="ruby variable bold">@magazine</code><code class="ruby plain">, </code><code class="ruby variable bold">@ad</code><code class="ruby plain">) </code><code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>而且还可使用 <code>url_for</code> 方法，指定一组对象，Rails 会自动决定使用哪个路由：</p><div class="code_container">
<div><div id="highlighter_150050" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Ad details'</code><code class="ruby plain">, url_for([</code><code class="ruby variable bold">@magazine</code><code class="ruby plain">, </code><code class="ruby variable bold">@ad</code><code class="ruby plain">]) </code><code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>此时，Rails 知道 <code>@magazine</code> 是 <code>Magazine</code> 的实例，<code>@ad</code> 是 <code>Ad</code> 的实例，所以会调用 <code>magazine_ad_path</code> 帮助方法。使用 <code>link_to</code> 等方法时，无需使用完整的 <code>url_for</code> 方法，直接指定对象即可：</p><div class="code_container">
<div><div id="highlighter_452278" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Ad details'</code><code class="ruby plain">, [</code><code class="ruby variable bold">@magazine</code><code class="ruby plain">, </code><code class="ruby variable bold">@ad</code><code class="ruby plain">] </code><code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果想链接到一本杂志，可以这么做：</p><div class="code_container">
<div><div id="highlighter_478534" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Magazine details'</code><code class="ruby plain">, </code><code class="ruby variable bold">@magazine</code> <code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>要想链接到其他动作，把数组的第一个元素设为所需动作名即可：</p><div class="code_container">
<div><div id="highlighter_36259" class="syntaxhighlighter nogutter  htmlscript"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby script">&lt;%=</code> <code class="ruby plain">link_to </code><code class="ruby string">'Edit Ad'</code><code class="ruby plain">, [</code><code class="ruby color2">:edit</code><code class="ruby plain">, </code><code class="ruby variable bold">@magazine</code><code class="ruby plain">, </code><code class="ruby variable bold">@ad</code><code class="ruby plain">] </code><code class="ruby script">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>在这种用法中，会把模型实例转换成对应的 URL，这是资源式路由带来的主要好处之一。</p><h4 id="添加更多的-rest-架构动作">2.10 添加更多的 REST 架构动作</h4><p>可用的路由并不局限于 REST 路由默认创建的那七个，还可以添加额外的集合路由或成员路由。</p><h5 id="添加成员路由">2.10.1 添加成员路由</h5><p>要添加成员路由，在 <code>resource</code> 代码块中使用 <code>member</code> 块即可：</p><div class="code_container">
<div><div id="highlighter_807190" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">member </code><code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'preview'</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由能识别 <code>/photos/1/preview</code> 是个 GET 请求，映射到 <code>PhotosController</code> 的 <code>preview</code> 动作上，资源的 ID 传入 <code>params[:id]</code>。同时还生成了 <code>preview_photo_url</code> 和 <code>preview_photo_path</code> 两个帮助方法。</p><p>在 <code>member</code> 代码块中，每个路由都要指定使用的 HTTP 方法。可以使用 <code>get</code>，<code>patch</code>，<code>put</code>，<code>post</code> 或 <code>delete</code>。如果成员路由不多，可以不使用代码块形式，直接在路由上使用 <code>:on</code> 选项：</p><div class="code_container">
<div><div id="highlighter_644611" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'preview'</code><code class="ruby plain">, on: </code><code class="ruby color2">:member</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>也可以不使用 <code>:on</code> 选项，得到的成员路由是相同的，但资源 ID 存储在 <code>params[:photo_id]</code> 而不是 <code>params[:id]</code> 中。</p><h5 id="添加集合路由">2.10.2 添加集合路由</h5><p>添加集合路由的方式如下：</p><div class="code_container">
<div><div id="highlighter_496085" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">collection </code><code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'search'</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由能识别 <code>/photos/search</code> 是个 GET 请求，映射到 <code>PhotosController</code> 的 <code>search</code> 动作上。同时还会生成 <code>search_photos_url</code> 和 <code>search_photos_path</code> 两个帮助方法。</p><p>和成员路由一样，也可使用 <code>:on</code> 选项：</p><div class="code_container">
<div><div id="highlighter_472547" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'search'</code><code class="ruby plain">, on: </code><code class="ruby color2">:collection</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h5 id="添加额外新建动作的路由">2.10.3 添加额外新建动作的路由</h5><p>要添加额外的新建动作，可以使用 <code>:on</code> 选项：</p><div class="code_container">
<div><div id="highlighter_927735" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:comments</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'preview'</code><code class="ruby plain">, on: </code><code class="ruby color2">:new</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段代码能识别 <code>/comments/new/preview</code> 是个 GET 请求，映射到 <code>CommentsController</code> 的 <code>preview</code> 动作上。同时还会生成 <code>preview_new_comment_url</code> 和 <code>preview_new_comment_path</code> 两个路由帮助方法。</p><div class="info"><p>如果在资源式路由中添加了过多额外动作，这时就要停下来问自己，是不是要新建一个资源。</p></div><h3 id="非资源式路由">3 非资源式路由</h3><p>除了资源路由之外，Rails 还提供了强大功能，把任意 URL 映射到动作上。此时，不会得到资源式路由自动生成的一系列路由，而是分别声明各个路由。</p><p>虽然一般情况下要使用资源式路由，但也有一些情况使用简单的路由更合适。如果不合适，也不用非得使用资源实现程序的每种功能。</p><p>简单的路由特别适合把传统的 URL 映射到 Rails 动作上。</p><h4 id="绑定参数">3.1 绑定参数</h4><p>声明常规路由时，可以提供一系列 Symbol，做为 HTTP 请求的一部分，传入 Rails 程序。其中两个 Symbol 有特殊作用：<code>:controller</code> 映射程序的控制器名，<code>:action</code> 映射控制器中的动作名。例如，有下面的路由：</p><div class="code_container">
<div><div id="highlighter_180775" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">':controller(/:action(/:id))'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果 <code>/photos/show/1</code> 由这个路由处理（没匹配路由文件中其他路由声明），会映射到 <code>PhotosController</code> 的 <code>show</code> 动作上，最后一个参数 <code>"1"</code> 可通过 <code>params[:id]</code> 获取。上述路由还能处理 <code>/photos</code> 请求，映射到 <code>PhotosController#index</code>，因为 <code>:action</code> 和 <code>:id</code> 放在括号中，是可选参数。</p><h4 id="动态路径片段">3.2 动态路径片段</h4><p>在常规路由中可以使用任意数量的动态片段。<code>:controller</code> 和 <code>:action</code> 之外的参数都会存入 <code>params</code> 传给动作。如果有下面的路由：</p><div class="code_container">
<div><div id="highlighter_554095" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">':controller/:action/:id/:user_id'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>/photos/show/1/2</code> 请求会映射到 <code>PhotosController</code> 的 <code>show</code> 动作。<code>params[:id]</code> 的值是 <code>"1"</code>，<code>params[:user_id]</code> 的值是 <code>"2"</code>。</p><div class="note"><p>匹配控制器时不能使用 <code>:namespace</code> 或 <code>:module</code>。如果需要这种功能，可以为控制器做个约束，匹配所需的命名空间。例如：
I&gt;
I&gt;
I&gt;<code>ruby
NOTE: get ':controller(/:action(/:id))', controller: /admin\/[^\/]+/
NOTE:</code></p></div><div class="info"><p>默认情况下，动态路径片段中不能使用点号，因为点号是格式化路由的分隔符。如果需要在动态路径片段中使用点号，可以添加一个约束条件。例如，<code>id: /[^\/]+/</code> 可以接受除斜线之外的所有字符。</p></div><h4 id="静态路径片段">3.3 静态路径片段</h4><p>声明路由时可以指定静态路径片段，片段前不加冒号即可：</p><div class="code_container">
<div><div id="highlighter_335843" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">':controller/:action/:id/with_user/:user_id'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由能响应 <code>/photos/show/1/with_user/2</code> 这种路径。此时，<code>params</code> 的值为 <code>{ controller: 'photos', action: 'show', id: '1', user_id: '2' }</code>。</p><h4 id="查询字符串">3.4 查询字符串</h4><p><code>params</code> 中还包含查询字符串中的所有参数。例如，有下面的路由：</p><div class="code_container">
<div><div id="highlighter_179759" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">':controller/:action/:id'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>/photos/show/1?user_id=2</code> 请求会映射到 <code>Photos</code> 控制器的 <code>show</code> 动作上。<code>params</code> 的值为 <code>{ controller: 'photos', action: 'show', id: '1', user_id: '2' }</code>。</p><h4 id="定义默认值">3.5 定义默认值</h4><p>在路由中无需特别使用 <code>:controller</code> 和 <code>:action</code>，可以指定默认值：</p><div class="code_container">
<div><div id="highlighter_958488" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这样声明路由后，Rails 会把 <code>/photos/12</code> 映射到 <code>PhotosController</code> 的 <code>show</code> 动作上。</p><p>路由中的其他部分也使用 <code>:defaults</code> 选项设置默认值。甚至可以为没有指定的动态路径片段设定默认值。例如：</p><div class="code_container">
<div><div id="highlighter_458906" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code><code class="ruby plain">, defaults: { format: </code><code class="ruby string">'jpg'</code> <code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Rails 会把 <code>photos/12</code> 请求映射到 <code>PhotosController</code> 的 <code>show</code> 动作上，把 <code>params[:format]</code> 的值设为 <code>"jpg"</code>。</p><h4 id="命名路由">3.6 命名路由</h4><p>使用 <code>:as</code> 选项可以为路由起个名字：</p><div class="code_container">
<div><div id="highlighter_101280" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'exit'</code><code class="ruby plain">, to: </code><code class="ruby string">'sessions#destroy'</code><code class="ruby plain">, as: </code><code class="ruby color2">:logout</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由会生成 <code>logout_path</code> 和 <code>logout_url</code> 这两个具名路由帮助方法。调用 <code>logout_path</code> 方法会返回 <code>/exit</code>。</p><p>使用 <code>:as</code> 选项还能重设资源的路径方法，例如：</p><div class="code_container">
<div><div id="highlighter_70929" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">':username'</code><code class="ruby plain">, to: </code><code class="ruby string">'users#show'</code><code class="ruby plain">, as: </code><code class="ruby color2">:user</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由会定义一个名为 <code>user_path</code> 的方法，可在控制器、帮助方法和视图中使用。在 <code>UsersController</code> 的 <code>show</code> 动作中，<code>params[:username]</code> 的值即用户的用户名。如果不想使用 <code>:username</code> 作为参数名，可在路由声明中修改。</p><h4 id="http-方法约束">3.7 HTTP 方法约束</h4><p>一般情况下，应该使用 <code>get</code>、<code>post</code>、<code>put</code>、<code>patch</code> 和 <code>delete</code> 方法限制路由可使用的 HTTP 方法。如果使用 <code>match</code> 方法，可以通过 <code>:via</code> 选项一次指定多个 HTTP 方法：</p><div class="code_container">
<div><div id="highlighter_766888" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">match </code><code class="ruby string">'photos'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code><code class="ruby plain">, via: [</code><code class="ruby color2">:get</code><code class="ruby plain">, </code><code class="ruby color2">:post</code><code class="ruby plain">]</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>如果某个路由想使用所有 HTTP 方法，可以使用 <code>via: :all</code>：</p><div class="code_container">
<div><div id="highlighter_797775" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">match </code><code class="ruby string">'photos'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code><code class="ruby plain">, via: </code><code class="ruby color2">:all</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="note"><p>同个路由即处理 <code>GET</code> 请求又处理 <code>POST</code> 请求有安全隐患。一般情况下，除非有特殊原因，切记不要允许在一个动作上使用所有 HTTP 方法。</p></div><h4 id="路径片段约束">3.8 路径片段约束</h4><p>可使用 <code>:constraints</code> 选项限制动态路径片段的格式：</p><div class="code_container">
<div><div id="highlighter_823947" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code><code class="ruby plain">, constraints: { id: /[</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">]\d{</code><code class="ruby constants">5</code><code class="ruby plain">}/ }</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由能匹配 <code>/photos/A12345</code>，但不能匹配 <code>/photos/893</code>。上述路由还可简化成：</p><div class="code_container">
<div><div id="highlighter_931448" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#show'</code><code class="ruby plain">, id: /[</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">]\d{</code><code class="ruby constants">5</code><code class="ruby plain">}/</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>:constraints</code> 选项中的正则表达式不能使用“锚记”。例如，下面的路由是错误的：</p><div class="code_container">
<div><div id="highlighter_130634" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'posts#show'</code><code class="ruby plain">, constraints: {id: /^\d/}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>之所以不能使用锚记，是因为所有正则表达式都从头开始匹配。</p><p>例如，有下面的路由。如果 <code>to_param</code> 方法得到的值以数字开头，例如 <code>1-hello-world</code>，就会把请求交给 <code>posts</code> 控制器处理；如果 <code>to_param</code> 方法得到的值不以数字开头，例如 <code>david</code>，就交给 <code>users</code> 控制器处理。</p><div class="code_container">
<div><div id="highlighter_524051" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/:id'</code><code class="ruby plain">, to: </code><code class="ruby string">'posts#show'</code><code class="ruby plain">, constraints: { id: /\d.+/ }</code></div><div class="line number2 index1 alt1"><code class="ruby plain">get </code><code class="ruby string">'/:username'</code><code class="ruby plain">, to: </code><code class="ruby string">'users#show'</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="基于请求的约束">3.9 基于请求的约束</h4><p>约束还可以根据任何一个返回值为字符串的 <a href="http://guides.ruby-china.org/action_controller_overview.html#the-request-object">Request</a> 方法设定。</p><p>基于请求的约束和路径片段约束的设定方式一样：</p><div class="code_container">
<div><div id="highlighter_618704" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos'</code><code class="ruby plain">, constraints: {subdomain: </code><code class="ruby string">'admin'</code><code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>约束还可使用代码块形式：</p><div class="code_container">
<div><div id="highlighter_271285" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">namespace </code><code class="ruby color2">:admin</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">constraints subdomain: </code><code class="ruby string">'admin'</code> <code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="高级约束">3.10 高级约束</h4><p>如果约束很复杂，可以指定一个能响应 <code>matches?</code> 方法的对象。假设要用 <code>BlacklistConstraint</code> 过滤所有用户，可以这么做：</p><div class="code_container">
<div><div id="highlighter_181873" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">BlacklistConstraint</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">initialize</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby variable bold">@ips</code> <code class="ruby plain">= Blacklist.retrieve_ips</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">matches?(request)</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby variable bold">@ips</code><code class="ruby plain">.include?(request.remote_ip)</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number9 index8 alt2"><code class="ruby keyword">end</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="ruby plain">TwitterClone::Application.routes.draw </code><code class="ruby keyword">do</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'*path'</code><code class="ruby plain">, to: </code><code class="ruby string">'blacklist#index'</code><code class="ruby plain">,</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">constraints: BlacklistConstraint.</code><code class="ruby keyword">new</code></div><div class="line number14 index13 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>约束还可以在 lambda 中指定：</p><div class="code_container">
<div><div id="highlighter_181843" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">TwitterClone::Application.routes.draw </code><code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">get </code><code class="ruby string">'*path'</code><code class="ruby plain">, to: </code><code class="ruby string">'blacklist#index'</code><code class="ruby plain">,</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">constraints: lambda { |request| Blacklist.retrieve_ips.include?(request.remote_ip) }</code></div><div class="line number4 index3 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>matches?</code> 方法和 lambda 的参数都是 <code>request</code> 对象。</p><h4 id="通配片段">3.11 通配片段</h4><p>路由中的通配符可以匹配其后的所有路径片段。例如：</p><div class="code_container">
<div><div id="highlighter_607021" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'photos/*other'</code><code class="ruby plain">, to: </code><code class="ruby string">'photos#unknown'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由可以匹配 <code>photos/12</code> 或 <code>/photos/long/path/to/12</code>，<code>params[:other]</code> 的值为 <code>"12"</code> 或 <code>"long/path/to/12"</code>。以星号开头的路径片段叫做“通配片段”。</p><p>通配片段可以出现在路由的任何位置。例如：</p><div class="code_container">
<div><div id="highlighter_438297" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'books/*section/:title'</code><code class="ruby plain">, to: </code><code class="ruby string">'books#show'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由可以匹配 <code>books/some/section/last-words-a-memoir</code>，<code>params[:section]</code> 的值为 <code>'some/section'</code>，<code>params[:title]</code> 的值为 <code>'last-words-a-memoir'</code>。</p><p>严格来说，路由中可以有多个通配片段。匹配器会根据直觉赋值各片段。例如：</p><div class="code_container">
<div><div id="highlighter_598024" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'*a/foo/*b'</code><code class="ruby plain">, to: </code><code class="ruby string">'test#index'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由可以匹配 <code>zoo/woo/foo/bar/baz</code>，<code>params[:a]</code> 的值为 <code>'zoo/woo'</code>，<code>params[:b]</code> 的值为 <code>'bar/baz'</code>。</p><div class="note"><p>如果请求 <code>'/foo/bar.json'</code>，那么 <code>params[:pages]</code> 的值为 <code>'foo/bar'</code>，请求类型为 JSON。如果想使用 Rails 3.0.x 中的表现，可以指定 <code>format: false</code> 选项，如下所示：
I&gt;
I&gt;
I&gt;<code>ruby
NOTE: get '*pages', to: 'pages#show', format: false
NOTE:</code>
I&gt;
NOTE: 如果必须指定格式，可以指定 <code>format: true</code> 选项，如下所示：
I&gt;
I&gt;
I&gt;<code>ruby
NOTE: get '*pages', to: 'pages#show', format: true
NOTE:</code></p></div><h4 id="重定向">3.12 重定向</h4><p>在路由中可以使用 <code>redirect</code> 帮助方法把一个路径重定向到另一个路径：</p><div class="code_container">
<div><div id="highlighter_465548" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/stories'</code><code class="ruby plain">, to: redirect(</code><code class="ruby string">'/posts'</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>重定向时还可使用匹配的动态路径片段：</p><div class="code_container">
<div><div id="highlighter_952670" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/stories/:name'</code><code class="ruby plain">, to: redirect(</code><code class="ruby string">'/posts/%{name}'</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>redirect</code> 还可使用代码块形式，传入路径参数和 <code>request</code> 对象作为参数：</p><div class="code_container">
<div><div id="highlighter_718339" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'/stories/:name'</code><code class="ruby plain">, to: redirect {|path_params, req| </code><code class="ruby string">"/posts/#{path_params[:name].pluralize}"</code> <code class="ruby plain">}</code></div><div class="line number2 index1 alt1"><code class="ruby plain">get </code><code class="ruby string">'/stories'</code><code class="ruby plain">, to: redirect {|path_params, req| </code><code class="ruby string">"/posts/#{req.subdomain}"</code> <code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>注意，<code>redirect</code> 实现的是 301 "Moved Permanently" 重定向，有些浏览器或代理服务器会缓存这种重定向，导致旧的页面不可用。</p><p>如果不指定主机（<code>http://www.example.com</code>），Rails 会从当前请求中获取。</p><h4 id="映射到-rack-程序">3.13 映射到 Rack 程序</h4><p>除了使用字符串，例如 <code>'posts#index'</code>，把请求映射到 <code>PostsController</code> 的 <code>index</code> 动作上之外，还可使用 <a href="http://guides.ruby-china.org/rails_on_rack.html">Rack</a> 程序作为端点：</p><div class="code_container">
<div><div id="highlighter_896467" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">match </code><code class="ruby string">'/application.js'</code><code class="ruby plain">, to: Sprockets, via: </code><code class="ruby color2">:all</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>只要 <code>Sprockets</code> 能响应 <code>call</code> 方法，而且返回 <code>[status, headers, body]</code> 形式的结果，路由器就不知道这是个 Rack 程序还是动作。这里使用 <code>via: :all</code> 是正确的，因为我们想让 Rack 程序自行判断，处理所有 HTTP 方法。</p><div class="note"><p>其实 <code>'posts#index'</code> 的复杂形式是 <code>PostsController.action(:index)</code>，得到的也是个合法的 Rack 程序。</p></div><h4 id="使用-root">3.14 使用 <code>root</code>
</h4><p>使用 <code>root</code> 方法可以指定怎么处理 <code>'/'</code> 请求：</p><div class="code_container">
<div><div id="highlighter_260671" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">root to: </code><code class="ruby string">'pages#main'</code></div><div class="line number2 index1 alt1"><code class="ruby plain">root </code><code class="ruby string">'pages#main'</code> <code class="ruby plain"># shortcut </code><code class="ruby keyword">for</code> <code class="ruby plain">the above</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><code>root</code> 路由应该放在文件的顶部，因为这是最常用的路由，应该先匹配。</p><div class="note"><p><code>root</code> 路由只处理映射到动作上的 <code>GET</code> 请求。</p></div><p>在命名空间和作用域中也可使用 <code>root</code>。例如：</p><div class="code_container">
<div><div id="highlighter_52697" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">namespace </code><code class="ruby color2">:admin</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">root to: </code><code class="ruby string">"admin#index"</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">root to: </code><code class="ruby string">"home#index"</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="unicode-字符路由">3.15 Unicode 字符路由</h4><p>路由中可直接使用 Unicode 字符。例如：</p><div class="code_container">
<div><div id="highlighter_47162" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">get </code><code class="ruby string">'こんにちは'</code><code class="ruby plain">, to: </code><code class="ruby string">'welcome#index'</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3 id="定制资源式路由">4 定制资源式路由</h3><p>虽然 <code>resources :posts</code> 默认生成的路由和帮助方法都满足大多数需求，但有时还是想做些定制。Rails 允许对资源式帮助方法做几乎任何形式的定制。</p><h4 id="指定使用的控制器">4.1 指定使用的控制器</h4><p><code>:controller</code> 选项用来指定资源使用的控制器。例如：</p><div class="code_container">
<div><div id="highlighter_122835" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, controller: </code><code class="ruby string">'images'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>能识别以 <code>/photos</code> 开头的请求，但交给 <code>Images</code> 控制器处理：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>images#index</td>
<td>photos_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>images#new</td>
<td>new_photo_path</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>images#create</td>
<td>photos_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>images#show</td>
<td>photo_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>images#edit</td>
<td>edit_photo_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>images#update</td>
<td>photo_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>images#destroy</td>
<td>photo_path(:id)</td>
</tr>
</tbody>
</table>
<div class="note"><p>要使用 <code>photos_path</code>、<code>new_photo_path</code> 等生成该资源的路径。</p></div><p>命名空间中的控制器可通过目录形式指定。例如：</p><div class="code_container">
<div><div id="highlighter_696508" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:user_permissions</code><code class="ruby plain">, controller: </code><code class="ruby string">'admin/user_permissions'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由会交给 <code>Admin::UserPermissions</code> 控制器处理。</p><div class="note"><p>只支持目录形式。如果使用 Ruby 常量形式，例如 <code>controller: 'Admin::UserPermissions'</code>，会导致路由报错。</p></div><h4 id="指定约束">4.2 指定约束</h4><p>可以使用 <code>:constraints</code>选项指定 <code>id</code> 必须满足的格式。例如：</p><div class="code_container">
<div><div id="highlighter_977213" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, constraints: {id: /[</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">][</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">][</code><code class="ruby constants">0</code><code class="ruby plain">-</code><code class="ruby constants">9</code><code class="ruby plain">]+/}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这个路由声明限制参数 <code>:id</code> 必须匹配指定的正则表达式。因此，这个路由能匹配 <code>/photos/RR27</code>，不能匹配 <code>/photos/1</code>。</p><p>使用代码块形式可以把约束应用到多个路由上：</p><div class="code_container">
<div><div id="highlighter_168361" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">constraints(id: /[</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">][</code><code class="ruby constants">A</code><code class="ruby plain">-</code><code class="ruby constants">Z</code><code class="ruby plain">][</code><code class="ruby constants">0</code><code class="ruby plain">-</code><code class="ruby constants">9</code><code class="ruby plain">]+/) </code><code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:accounts</code></div><div class="line number4 index3 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="note"><p>当然了，在资源式路由中也能使用非资源式路由中的高级约束。</p></div><div class="info"><p>默认情况下，在 <code>:id</code> 参数中不能使用点号，因为点号是格式化路由的分隔符。如果需要在 <code>:id</code> 中使用点号，可以添加一个约束条件。例如，<code>id: /[^\/]+/</code> 可以接受除斜线之外的所有字符。</p></div><h4 id="改写具名帮助方法">4.3 改写具名帮助方法</h4><p><code>:as</code> 选项可以改写常规的具名路由帮助方法。例如：</p><div class="code_container">
<div><div id="highlighter_623312" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, as: </code><code class="ruby string">'images'</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>能识别以 <code>/photos</code> 开头的请求，交给 <code>PhotosController</code> 处理，但使用 <code>:as</code> 选项的值命名帮助方法：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>photos#index</td>
<td>images_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>photos#new</td>
<td>new_image_path</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>photos#create</td>
<td>images_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>photos#show</td>
<td>image_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>photos#edit</td>
<td>edit_image_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>photos#update</td>
<td>image_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>photos#destroy</td>
<td>image_path(:id)</td>
</tr>
</tbody>
</table>
<h4 id="改写-new-和-edit-片段">4.4 改写 <code>new</code> 和 <code>edit</code> 片段</h4><p><code>:path_names</code> 选项可以改写路径中自动生成的 <code>"new"</code> 和 <code>"edit"</code> 片段：</p><div class="code_container">
<div><div id="highlighter_258442" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, path_names: { </code><code class="ruby keyword">new</code><code class="ruby plain">: </code><code class="ruby string">'make'</code><code class="ruby plain">, edit: </code><code class="ruby string">'change'</code> <code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这样设置后，路由就能识别如下的路径：</p><div class="code_container">
<div><div id="highlighter_810614" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">/photos/make</code></div><div class="line number2 index1 alt1"><code class="plain plain">/photos/1/change</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="note"><p>这个选项并不能改变实际处理请求的动作名。上述两个路径还是交给 <code>new</code> 和 <code>edit</code> 动作处理。</p></div><div class="info"><p>如果想按照这种方式修改所有路由，可以使用作用域。
T&gt;
T&gt;
T&gt;<code>ruby
TIP: scope path_names: { new: 'make' } do
TIP:   # rest of your routes
TIP: end
TIP:</code></p></div><h4 id="为具名路由帮助方法加上前缀">4.5 为具名路由帮助方法加上前缀</h4><p>使用 <code>:as</code> 选项可在 Rails 为路由生成的路由帮助方法前加上前缀。这个选项可以避免作用域内外产生命名冲突。例如：</p><div class="code_container">
<div><div id="highlighter_331713" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope </code><code class="ruby string">'admin'</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, as: </code><code class="ruby string">'admin_photos'</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由会生成 <code>admin_photos_path</code> 和 <code>new_admin_photo_path</code> 等帮助方法。</p><p>要想为多个路由添加前缀，可以在 <code>scope</code> 方法中设置 <code>:as</code> 选项：</p><div class="code_container">
<div><div id="highlighter_969023" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope </code><code class="ruby string">'admin'</code><code class="ruby plain">, as: </code><code class="ruby string">'admin'</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, </code><code class="ruby color2">:accounts</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, </code><code class="ruby color2">:accounts</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由会生成 <code>admin_photos_path</code> 和 <code>admin_accounts_path</code> 等帮助方法，分别映射到 <code>/admin/photos</code> 和 <code>/admin/accounts</code> 上。</p><div class="note"><p><code>namespace</code> 作用域会自动添加 <code>:as</code> 以及 <code>:module</code> 和 <code>:path</code> 前缀。</p></div><p>路由帮助方法的前缀还可使用具名参数：</p><div class="code_container">
<div><div id="highlighter_330729" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope </code><code class="ruby string">':username'</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:posts</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由能识别 <code>/bob/posts/1</code> 这种请求，在控制器、帮助方法和视图中可使用 <code>params[:username]</code> 获取 <code>username</code> 的值。</p><h4 id="限制生成的路由">4.6 限制生成的路由</h4><p>默认情况下，Rails 会为每个 REST 路由生成七个默认动作（<code>index</code>，<code>show</code>，<code>new</code>，<code>create</code>，<code>edit</code>，<code>update</code> 和 <code>destroy</code>）对应的路由。你可以使用 <code>:only</code> 和 <code>:except</code> 选项调整这种行为。<code>:only</code> 选项告知 Rails，只生成指定的路由：</p><div class="code_container">
<div><div id="highlighter_130054" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, only: [</code><code class="ruby color2">:index</code><code class="ruby plain">, </code><code class="ruby color2">:show</code><code class="ruby plain">]</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>此时，向 <code>/photos</code> 能发起 GET 请求，但不能发起 <code>POST</code> 请求（正常情况下由 <code>create</code> 动作处理）。</p><p><code>:except</code> 选项指定<strong>不用</strong>生成的路由：</p><div class="code_container">
<div><div id="highlighter_904388" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:photos</code><code class="ruby plain">, except: </code><code class="ruby color2">:destroy</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>此时，Rails 会生成除 <code>destroy</code>（向 <code>/photos/:id</code> 发起的 <code>DELETE</code> 请求）之外的所有常规路由。</p><div class="info"><p>如果程序中有很多 REST 路由，使用 <code>:only</code> 和 <code>:except</code> 指定只生成所需的路由，可以节省内存，加速路由处理过程。</p></div><h4 id="翻译路径">4.7 翻译路径</h4><p>使用 <code>scope</code> 时，可以改写资源生成的路径名：</p><div class="code_container">
<div><div id="highlighter_884017" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">scope(path_names: { </code><code class="ruby keyword">new</code><code class="ruby plain">: </code><code class="ruby string">'neu'</code><code class="ruby plain">, edit: </code><code class="ruby string">'bearbeiten'</code> <code class="ruby plain">}) </code><code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:categories</code><code class="ruby plain">, path: </code><code class="ruby string">'kategorien'</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Rails 为 <code>CategoriesController</code> 生成的路由如下：</p>
<table class="responsive">
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>控制器#动作</th>
<th>具名帮助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/kategorien</td>
<td>categories#index</td>
<td>categories_path</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/neu</td>
<td>categories#new</td>
<td>new_category_path</td>
</tr>
<tr>
<td>POST</td>
<td>/kategorien</td>
<td>categories#create</td>
<td>categories_path</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/:id</td>
<td>categories#show</td>
<td>category_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/:id/bearbeiten</td>
<td>categories#edit</td>
<td>edit_category_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/kategorien/:id</td>
<td>categories#update</td>
<td>category_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/kategorien/:id</td>
<td>categories#destroy</td>
<td>category_path(:id)</td>
</tr>
</tbody>
</table>
<h4 id="改写单数形式">4.8 改写单数形式</h4><p>如果想定义资源的单数形式，需要在 <code>Inflector</code> 中添加额外的规则：</p><div class="code_container">
<div><div id="highlighter_817230" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">ActiveSupport::Inflector.inflections </code><code class="ruby keyword">do</code> <code class="ruby plain">|inflect|</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">inflect.irregular </code><code class="ruby string">'tooth'</code><code class="ruby plain">, </code><code class="ruby string">'teeth'</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="在嵌套资源中使用-:as-选项">4.9 在嵌套资源中使用 <code>:as</code> 选项</h4><p><code>:as</code> 选项可以改自动生成的嵌套路由帮助方法名。例如：</p><div class="code_container">
<div><div id="highlighter_629033" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:magazines</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">resources </code><code class="ruby color2">:ads</code><code class="ruby plain">, as: </code><code class="ruby string">'periodical_ads'</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>这段路由会生成 <code>magazine_periodical_ads_url</code> 和 <code>edit_magazine_periodical_ad_path</code> 等帮助方法。</p><h3 id="路由审查和测试">5 路由审查和测试</h3><p>Rails 提供有路由审查和测试功能。</p><h4 id="列出现有路由">5.1 列出现有路由</h4><p>要想查看程序完整的路由列表，可以在<strong>开发环境</strong>中使用浏览器打开 <code>http://localhost:3000/rails/info/routes</code>。也可以在终端执行 <code>rake routes</code> 任务查看，结果是一样的。</p><p>这两种方法都能列出所有路由，和在 <code>routes.rb</code> 中的定义顺序一致。你会看到每个路由的以下信息：</p>
<ul>
<li>路由名（如果有的话）</li>
<li>使用的 HTTP 方法（如果不响应所有方法）</li>
<li>匹配的 URL 模式</li>
<li>路由的参数</li>
</ul>
<p>例如，下面是执行 <code>rake routes</code> 命令后看到的一个 REST 路由片段：</p><div class="code_container">
<div><div id="highlighter_605445" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">users GET&nbsp;&nbsp;&nbsp; /users(.:format)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users#index</code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">POST&nbsp;&nbsp; /users(.:format)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users#create</code></div><div class="line number3 index2 alt2"><code class="plain spaces">&nbsp;</code><code class="plain plain">new_user GET&nbsp;&nbsp;&nbsp; /users/new(.:format)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users#new</code></div><div class="line number4 index3 alt1"><code class="plain plain">edit_user GET&nbsp;&nbsp;&nbsp; /users/:id/edit(.:format) users#edit</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>可以使用环境变量 <code>CONTROLLER</code> 限制只显示映射到该控制器上的路由：</p><div class="code_container">
<div><div id="highlighter_224386" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">$ CONTROLLER=users rake routes</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="info"><p>拉宽终端窗口直至没断行，这时看到的 <code>rake routes</code> 输出更完整。</p></div><h4 id="测试路由">5.2 测试路由</h4><p>和程序的其他部分一样，路由也要测试。Rails <a href="http://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html">内建了三个断言</a>，可以简化测试：</p>
<ul>
<li><code>assert_generates</code></li>
<li><code>assert_recognizes</code></li>
<li><code>assert_routing</code></li>
</ul>
<h5 id="assert_generates-断言">5.2.1 <code>assert_generates</code> 断言</h5><p><code>assert_generates</code> 检测提供的选项是否能生成默认路由或自定义路由。例如：</p><div class="code_container">
<div><div id="highlighter_746858" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">assert_generates </code><code class="ruby string">'/photos/1'</code><code class="ruby plain">, { controller: </code><code class="ruby string">'photos'</code><code class="ruby plain">, action: </code><code class="ruby string">'show'</code><code class="ruby plain">, id: </code><code class="ruby string">'1'</code> <code class="ruby plain">}</code></div><div class="line number2 index1 alt1"><code class="ruby plain">assert_generates </code><code class="ruby string">'/about'</code><code class="ruby plain">, controller: </code><code class="ruby string">'pages'</code><code class="ruby plain">, action: </code><code class="ruby string">'about'</code></div></div></td></tr></tbody></table></div></div>
</div>
<h5 id="assert_recognizes-断言">5.2.2 <code>assert_recognizes</code> 断言</h5><p><code>assert_recognizes</code> 是 <code>assert_generates</code> 的反测试，检测提供的路径是否能陪识别并交由特定的控制器处理。例如：</p><div class="code_container">
<div><div id="highlighter_887847" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">assert_recognizes({ controller: </code><code class="ruby string">'photos'</code><code class="ruby plain">, action: </code><code class="ruby string">'show'</code><code class="ruby plain">, id: </code><code class="ruby string">'1'</code> <code class="ruby plain">}, </code><code class="ruby string">'/photos/1'</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>可以使用 <code>:method</code> 参数指定使用的 HTTP 方法：</p><div class="code_container">
<div><div id="highlighter_827991" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">assert_recognizes({ controller: </code><code class="ruby string">'photos'</code><code class="ruby plain">, action: </code><code class="ruby string">'create'</code> <code class="ruby plain">}, { path: </code><code class="ruby string">'photos'</code><code class="ruby plain">, method: </code><code class="ruby color2">:post</code> <code class="ruby plain">})</code></div></div></td></tr></tbody></table></div></div>
</div>
<h5 id="assert_routing-断言">5.2.3 <code>assert_routing</code> 断言</h5><p><code>assert_routing</code> 做双向测试：检测路径是否能生成选项，以及选项能否生成路径。因此，综合了 <code>assert_generates</code> 和 <code>assert_recognizes</code> 两个断言。</p><div class="code_container">
<div><div id="highlighter_861966" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">assert_routing({ path: </code><code class="ruby string">'photos'</code><code class="ruby plain">, method: </code><code class="ruby color2">:post</code> <code class="ruby plain">}, { controller: </code><code class="ruby string">'photos'</code><code class="ruby plain">, action: </code><code class="ruby string">'create'</code> <code class="ruby plain">})</code></div></div></td></tr></tbody></table></div></div>
</div>


        <h3>反馈</h3>
        <p>
          欢迎帮忙改善指南质量。
        </p>
        <p>
          如发现任何错误，欢迎修正。开始贡献前，可先行阅读<a href="http://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">贡献指南：文档</a>。
        </p>
        <p>翻译如有错误，深感抱歉，欢迎 <a href="https://github.com/ruby-china/guides/fork">Fork</a> 修正，或至此处<a href="https://github.com/ruby-china/guides/issues/new">回报</a>。</p>
        <p>
          文章可能有未完成或过时的内容。请先检查 <a href="http://edgeguides.rubyonrails.org/">Edge Guides</a> 来确定问题在 master 是否已经修掉了。再上 master 补上缺少的文件。内容参考 <a href="http://guides.ruby-china.org/ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</a>来了解行文风格。
        </p>
        <p>最后，任何关于 Ruby on Rails 文档的讨论，欢迎到 <a href="http://groups.google.com/group/rubyonrails-docs">rubyonrails-docs 邮件群组</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide">
  <div id="footer">
    <div class="wrapper">
      <p>本著作采用<a href="https://creativecommons.org/licenses/by-sa/4.0/">创用 CC 姓名标示-相同方式分享 4.0 国际授权条款</a>授权。</p>
<p>“Rails”、“Ruby on Rails”，以及 Rails logo 为 David Heinemeier Hansson 的商标。版权所有。</p>

    </div>
  </div>

  <script async="" src="./Rails 路由全解 — Ruby on Rails 指南_files/analytics.js"></script><script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/jquery.min.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/responsive-tables.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/guides.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/shCore.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/shBrushRuby.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/shBrushXml.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/shBrushSql.js"></script>
  <script type="text/javascript" src="./Rails 路由全解 — Ruby on Rails 指南_files/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    // ga('create', '', 'ruby-china.github.io');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

  </script>


</body></html>